flowchart TD
  %% Root / Auth
  Splash["Splash\n(vérif. session)"] -->|nouveau| Onboarding["Onboarding\n(carousel)"]
  Splash -->|session valide| AppRoot["App Root\n(Tabs)"]

  Onboarding --> Login["Login / Register\n(OTP)"]
  Login --> OTP["OTP Verification"]
  OTP --> ProfileSetup["Profile Setup\n(select role & capabilities)"]
  ProfileSetup --> AppRoot

  %% Main Tabs (subgraph)
  subgraph Tabs [Barre inférieure - Tabs]
    direction LR
    HomeTab["Home\n(Discover)"]
    MarketplaceTab["Marketplace\n(Beats / Services)"]
    UploadTab["Upload / Sell"]
    WalletTab["Wallet"]
    ProfileTab["Profile"]
  end

  AppRoot --> Tabs

  %% HOME flow
  HomeTab --> Search["Search / Filters"]
  HomeTab --> BeatsList["Beats List"]
  HomeTab --> ServicesList["Services List"]
  BeatsList --> BeatDetails["Beat Details\n(preview 30s)"]
  ServicesList --> ServiceDetails["Service Details"]

  %% MARKETPLACE flow
  MarketplaceTab --> BeatsList
  MarketplaceTab --> SamplesList["Samples & Kits"]
  BeatsList -->|select| BeatDetails
  BeatDetails --> Checkout["Checkout / Cart"]
  ServiceDetails --> BookingForm["Booking Form"]

  %% PAYMENT / ESCROW flow
  Checkout --> Payment["Payment Provider\n(Wave/OM)"]
  Payment --> PaymentWebhook["Payment Callback\n(validate + set paid_held)"]
  PaymentWebhook --> PaymentSuccess["Payment Success\n(status=paid_held)"]
  PaymentSuccess --> GenerateDownload["Generate Download Token / URL"]
  GenerateDownload --> DownloadViewer["Download Viewer / Player"]
  PaymentWebhook -->|admin| Dispute["Dispute / Refund"]
  Dispute --> AdminPanel["Admin: Dispute Management"]

  %% UPLOAD / SELL flow
  UploadTab --> UploadCenter["Upload Center\n(preview 30s)"]
  UploadCenter --> UploadComplete["Upload Complete\n(create product status=pending)"]
  UploadComplete --> AdminApproval["Admin Approval"]
  AdminApproval -->|approved| ProductActive["Product Active"]
  ProductActive --> MyProducts["My Products"]
  MyProducts --> BoostScreen["Boost Product / Profile"]

  %% WALLET flow
  WalletTab --> Wallet["Wallet\n(balance, history)"]
  Wallet --> WithdrawReq["Withdraw Request"]
  WithdrawReq --> WithdrawPending["Withdraw Pending (admin)"]
  WithdrawPending -->|confirm| WithdrawPaid["Withdraw Paid"]

  %% PURCHASES / LICENSES
  ProfileTab --> MyPurchases["My Purchases"]
  MyPurchases --> DownloadViewer
  MyPurchases --> Contracts["Contracts (PDF)"]

  %% PROFILE / RATINGS
  ProfileTab --> ProfileView["Profile View\n(public & self)"]
  ProfileView --> EditProfile["Edit Profile"]
  ProfileView --> Ratings["Ratings & Reviews"]
  Ratings --> RespondReview["Respond (seller)"]

  %% COMMUNICATION
  HomeTab --> Notifications["Notifications"]
  Notifications --> Inbox["Inbox / Messages"]
  BeatDetails -->|contact seller| Inbox
  ServiceDetails -->|contact| Inbox
  BookingForm --> Inbox

  %% ADMIN flows (separate)
  AdminPanel --> AdminDashboard["Admin Dashboard\n(products, transactions)"]
  AdminDashboard --> PendingProducts["Pending Products"]
  PendingProducts -->|approve/reject| AdminActions["Approve / Reject"]

  %% ERRORS & STATES
  AppRoot --> Offline["Offline / Error"]
  Offline --> Retry["Retry / Cached content"]

  %% Special states & links
  PaymentSuccess --> MyPurchases
  ProductActive --> BeatsList
  MyProducts --> EditProduct["Edit Product"]
  EditProduct --> UploadCenter

  %% Visual grouping
  classDef auth fill:#f7fafc,stroke:#cbd5e1;
  classDef main fill:#ffffff,stroke:#e2e8f0;
  class Splash,Onboarding,Login,OTP,ProfileSetup auth;
  class Tabs,HomeTab,MarketplaceTab,UploadTab,WalletTab,ProfileTab main;
